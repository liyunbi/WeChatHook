name: Build WeChat Hook

on: [push]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: 1. Install Theos Manually
        run: |
          # 手动克隆 Theos，不依赖任何脚本，确保路径 100% 可控
          git clone --recursive https://github.com/theos/theos.git $HOME/theos
          echo "THEOS=$HOME/theos" >> $GITHUB_ENV

      - name: 2. Download SDK (Zip Mode)
        run: |
          # 直接下载 zip 包，避开 git clone 的冲突和报错
          curl -L -o master.zip https://github.com/theos/sdks/archive/refs/heads/master.zip
          unzip -q master.zip
          # 创建目录并把解压出来的 SDK 塞进去
          mkdir -p $HOME/theos/sdks
          mv sdks-master/*.sdk $HOME/theos/sdks/

      - name: 3. Compile Forcefully
        run: |
          # 【核心修复点】
          # TARGET=iphone:clang:latest:latest 意思是：
          # "别管 Makefile 里写什么 14.5 了，直接用你刚才下载到的那个 SDK！"
          make package FINALPACKAGE=1 TARGET=iphone:clang:latest:latest

      - name: 4. Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: WeChatHook_Dylib
          # 这里的路径是 Theos 编译生成的默认路径
          path: .theos/obj/debug/WeChatHook.dylib
